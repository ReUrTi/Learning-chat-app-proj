<!DOCTYPE html>
<html xmlns:th="http://www.w3.org/1999/xhtml">
<head>

    <title>Домашняя страница</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <link rel="stylesheet" href="/css/indexFull.css">
</head>
<body>
<div class="header">
    <div class="page-actions" style="margin-right: auto;">
        <form action="/index" method="get" style="display: inline;">
            <button type="submit">Chat</button>
        </form>
    </div>

    <div class="search-container" id="search-container">
        <!-- Search input and button will be generated by JavaScript -->
    </div>

    <div class="user-actions" style="margin-left: auto;">
        <span th:text="${nickname}"></span>
        <form action="/profile" method="get" style="display: inline;">
            <button type="submit">Profile</button>
        </form>
        <form action="/logout" method="get" style="display: inline;">
            <button type="submit">Exit</button>
        </form>
    </div>
</div>

<div class="main">
    <div class="side" id="chat-list" style="overflow-y: auto;"></div>
    <div class="center" id="chat-container"></div>
    <div class="side">Правая часть</div>
</div>

<script>

    function createSearchContainer() {
        const searchContainer = document.getElementById('search-container');

        const form = document.createElement('form');
        form.action = "/search";
        form.method = "get";

        const inputLabel = document.createElement('label');

        const input = document.createElement('input');
        input.type = "text";
        input.name = "searchInput";
        input.placeholder = "Введите имя пользователя...";

        const button = document.createElement('button');
        button.type = "submit";

        const img = document.createElement('img');
        img.src = "/images/search-icon.png";
        img.alt = "Search";
        img.style.width = "16px";
        img.style.height = "16px";

        form.onsubmit = function(event) {
            event.preventDefault(); // Предотвращаем стандартную отправку формы

            const trimmedInput = input.value.trim();

            const validInputPattern = /^[a-zA-Z0-9-_]+$/;

            if (trimmedInput === "") {
                alert("Пожалуйста, введите значение в поле поиска.");
                return;
            }

            if (!validInputPattern.test(trimmedInput)) {
                alert("Пожалуйста, используйте только буквы, цифры, '-' и '_' в поле поиска.");
                return;
            }

            if (trimmedInput.length > 30) {
                alert("Пожалуйста, введите не более 30 символов.");
                return;
            }

            input.value = trimmedInput;

            form.submit();
        };

        button.appendChild(img);
        inputLabel.appendChild(input);
        form.appendChild(inputLabel);
        form.appendChild(button);
        searchContainer.appendChild(form);
    }

<!--  Chat list handler  -->

    const chatListContainer = document.getElementById('chat-list');
    const chatContainer = document.getElementById('chat-container');
    const authUserId = [[${authUserId}]];
    const authUserNickname = '[[${nickname}]]';
    const interlocutorId = [[${interlocutorId} != null ? ${interlocutorId} : 'null']];
    const interlocutorNickname = '[[${interlocutorNickname} != null ? ${interlocutorNickname} : 'null']]';
    let blockedByThem = [[${blockedByThem} != null ? ${blockedByThem} : 'null']];
    let blockedThem = [[${blockedThem} != null ? ${blockedThem} : 'null']];
    let chatId = [[${chatId} != null ? ${chatId} : 'null']];
    let lastLoadedChatDate = new Date().toISOString().slice(0, 19).replace("T", " ");
    let lastLoadedMessageDate = new Date().toISOString().slice(0, 19).replace("T", " ");
    let loadingChats = false;
    let hasMoreChats = true;
    let chatsBatchLimit = 0;
    let messagesBatchLimit = 0;
    let confirmedChatId = null;

    let stompClient = null;

    function initWebSocket() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        if (sessionStorage.getItem('stompConnected')) {
            console.log('STOMP is already connected.');
            if(interlocutorNickname != null){
                stompClient.subscribe('/user/topic/messages', handleMessages);
                stompClient.subscribe('/live/messages/${interlocutorId}/${authUserId}', function(){});
            }
            return;
        }

        stompClient.connect({}, function(frame) {
            console.log('STOMP has been connected:', frame);
            sessionStorage.setItem('stompConnected', 'true');
            stompClient.send("/app/connect", {}, '');
            stompClient.subscribe('/topic/activity', (message) => {
                console.log('Heartbeat response:', message.body);
            });
            setInterval(() => {
                stompClient.send("/app/heartbeat", {}, '');
            }, 10000);

            stompClient.subscribe('/user/topic/chats', handleChats);
            stompClient.subscribe('/live/chats/${authUserId}', function(){});
            if(interlocutorNickname != null){
                stompClient.subscribe('/user/topic/messages', handleMessages);
                stompClient.subscribe('/live/messages/${interlocutorId}/${authUserId}', function(){});
                loadMessages();
            }
            loadChats(new Date().toISOString().slice(0, 19).replace("T", " "));
        }, function(error) {
            console.error('Error STOMP:', error);
        });

        socket.onclose = function () {
            console.error('Connection lost. Reload the page.');
        };
    }

    async function handleChats(response) {
        const data = await JSON.parse(response.body);
        console.log("Received response:", data);

        if (data.chats.length === 0) {
            hasMoreChats = false;
            chatListContainer.removeEventListener('scroll', checkScroll);
        } else {
            data.chats.forEach(chat => {
                renderChatLazy(chat);
            });
            lastLoadedChatDate = data.lastChatDate.substring(0, 19).replace("T", " ");
        }
    }

    async function handleMessages(response){
        const data = await JSON.parse(response.body);
        console.log("Received response:", data);
    }

    async function loadChats(lastDate) {
        if (loadingChats || !hasMoreChats) return;

        loadingChats = true;
        try {
            const request = {
                limit: 20 + chatsBatchLimit,
                lastLoaded: lastDate,
                userId: authUserId
            };

            await stompClient.send('/app/chats/lazy', { 'Content-Type': 'application/json' }, JSON.stringify(request));
        } catch (error) {
            console.error("Ошибка при загрузке данных:", error);
        } finally {
            loadingChats = false;
        }
    }

    function renderChatLazy(chat) {
        const chatElementId = `chatId-${chat.interlocutorId}`
        const chatElement = document.querySelector(`.side#chat-list #${chatElementId}`);
        if (chatElement) {
            return;
        }

        const chatDiv = document.createElement('div');
        chatDiv.className = 'chat-div';
        chatDiv.id = chatElementId;
        chatDiv.addEventListener('click', () => {
            window.location.href = `?interlocutorId=${chat.interlocutorId}`;
<!--            history.pushState(state, '', `?interlocutorId=${chat.interlocutorId}`);-->
        });
        chatDiv.addEventListener('mouseover', () => {
            chatDiv.style.backgroundColor = '#e0e0e0';
        });
        chatDiv.addEventListener('mouseout', () => {
            chatDiv.style.backgroundColor = '#f0f0f0';
        });

        const chatMain = document.createElement('div');
        chatMain.className = 'chat-main';
        chatMain.style.position = 'relative';

        const chatLastMessageInfo = document.createElement('div');
        chatLastMessageInfo.className = 'chat-lastMessage-info';
        chatLastMessageInfo.style.position = 'relative';

        const chatLastMessageText = document.createElement('div');
        chatLastMessageText.className = 'chat-lastMessage-text';
        chatLastMessageText.id = `chat-lastMessageText-${chat.interlocutorId}`;
        if(chat.lastMessage == null) {
            chatLastMessageText.innerHTML = '&nbsp;'
        } else if(chat.lastMessageUserId === Number(authUserId)) {
            chatLastMessageText.textContent = `You: ${chat.lastMessage}`;
        } else {
            chatLastMessageText.textContent = `${chat.lastMessage}`;
        }

        const chatLastMessageDate = document.createElement('div');
        chatLastMessageDate.className = 'chat-lastMessage-date';
        chatLastMessageDate.id = `chat-lastMessageDate-${chat.interlocutorId}`;
        if(chat.lastMessageDate == null) {
            chatLastMessageDate.innerHTML = '&nbsp;'
        } else {
            chatLastMessageDate.textContent = `${chat.lastMessageDate}`;
        }

        const chatInfo = document.createElement('div');
        chatInfo.className = 'chat-info';
        chatInfo.innerHTML = `
            <span>Nickname: ${chat.interlocutorNickname}</span><br>
            <span>ID: ${chat.interlocutorId}</span>
        `;

        const chatOther = document.createElement('div');
        chatOther.className = 'chat-other';

        const chatDropdown = document.createElement('div');
        chatOther.className = 'chat-dropdown';

        const chatDropdownButton = document.createElement('button');
        chatDropdownButton.innerText = '...';

        const chatDropdownContainer = document.createElement('div');
        chatDropdownContainer.className = 'dropdown';
        chatDropdownContainer.style.display = 'none';

        const hideChatDiv = document.createElement('div');
        hideChatDiv.className = 'dropdown-item';
        hideChatDiv.innerText = 'Hide';
        hideChatDiv.addEventListener('click', hideChat(                               ));
        chatDropdownContainer.appendChild(hideChatDiv);

        const blockChatDiv = document.createElement('div');
        blockChatDiv.className = 'dropdown-item';
        blockChatDiv.innerText = 'Block';
        blockChatDiv.addEventListener('click', blockChat(                               ));
        chatDropdownContainer.appendChild(blockChatDiv);

        let hideTimeout;
        chatDropdownButton.addEventListener('mouseenter', () => {
            clearTimeout(hideTimeout); // Очищаем таймер, если он установлен
            chatDropdownContainer.style.display = 'block'; // Показываем меню
        });
        chatDropdownButton.addEventListener('mouseleave', () => {
            hideTimeout = setTimeout(() => {
                chatDropdownContainer.style.display = 'none';
            }, 1000);
        });
        chatDropdownContainer.addEventListener('mouseenter', () => {
            clearTimeout(hideTimeout);
            chatDropdownContainer.style.display = 'block';
        });
        chatDropdownContainer.addEventListener('mouseleave', () => {
            hideTimeout = setTimeout(() => {
                chatDropdownContainer.style.display = 'none';
            }, 1000);
        });

        const chatUnread = document.createElement('div');
        chatUnread.className = 'chat-unread';
        if(chat.unreadCount >= 100) {
            chatUnread.innerHTML = `
                <span>99+</span>
            `;
        } else if (chat.unreadCount > 0) {
            chatUnread.innerHTML = `
                <span>${chat.unreadCount}</span>
            `;
        }

        chatDropdown.appendChild(chatDropdownButton);
        chatDropdown.appendChild(chatDropdownContainer);
        chatOther.appendChild(chatDropdown);
        chatOther.appendChild(chatUnread);

        chatMain.appendChild(chatInfo);
        chatMain.appendChild(chatOther);

        chatLastMessageInfo.appendChild(chatLastMessageText);
        chatLastMessageInfo.appendChild(chatLastMessageDate);

        chatDiv.appendChild(chatMain);
        chatDiv.appendChild(chatLastMessageInfo);

        chatListContainer.appendChild(chatDiv);
    }

    function hideChat() {
    }
    function blockChat() {
    }

    function checkScroll() {
        if (stompClient && stompClient.connected){
            const scrollPosition = chatListContainer.scrollTop + chatListContainer.clientHeight;
            const threshold = chatListContainer.scrollHeight - 100;

            if (scrollPosition >= threshold) {
                loadChats(lastLoadedChatDate);
            }
        }
    }
    chatListContainer.addEventListener('scroll', checkScroll);

<!--  Message-container handler  -->

    function loadMessages() {

    }

    function showEmpty() {
        const chatContainer = document.getElementById('chat-container');

        const noChat = document.createElement('div');
        noChat.innerHTML = `Open the existing chat, or find it using the search.`;
        noChat.className = 'no-chat';

        chatContainer.appendChild(noChat);
    }

    function showChat() {
        const chatContainer = document.getElementById('chat-container');

        const activeChat = document.createElement('div');
        activeChat.className = 'active-chat';

        upInterface = document.createElement('div');
        upInterface.className = 'up-interface';

        closeButtonDiv = document.createElement('div');
        closeButtonDiv.className = 'close-button-div';

        closeChatButton = document.createElement('button');
        closeChatButton.className = 'close-chat-button';
        closeChatButton.innerHTML = `
            <button onclick="">X</button>
        `;

        chatInfoDiv = document.createElement('div');
        chatInfoDiv.className = 'chat-info-div';
        chatInfoDiv.textContent = `${interlocutorNickname}`;

        optionsDiv = document.createElement('div');
        optionsDiv.className = 'options-div';

        optionsChatButton = document.createElement('button');
        optionsChatButton.className = 'options-chat-button';
        optionsChatButton.innerHTML = `
            <button onclick="">...</button>
        `;

        messagesContainer = document.createElement('div');
        messagesContainer.className = 'message-container';
        messagesContainer.id = 'message-container-id';

        outerMessagesContainer = document.createElement('div');
        outerMessagesContainer.className = 'outer-message-container';

        inputInterface = document.createElement('div');
        inputInterface.className = 'input-container';

        const messageInput = document.createElement('input');
        messageInput.type = 'text';
        messageInput.placeholder = 'Message...';
        inputInterface.appendChild(messageInput);

        const sendButton = document.createElement('button');
        sendButton.textContent = 'Send';
        inputInterface.appendChild(sendButton);

        sendButton.addEventListener('click', () => {
            const messageText = messageInput.value.trim();
            if (messageText) {
                handleOwnMessage(messageText);
                messageInput.value = '';
                messageInput.focus();
            }
        });
        messageInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendButton.click();
            }
        });

        upInterface.appendChild(closeButtonDiv);
        closeButtonDiv.appendChild(closeChatButton);
        upInterface.appendChild(chatInfoDiv);
        upInterface.appendChild(optionsDiv);
        optionsDiv.appendChild(optionsChatButton);

        outerMessagesContainer.appendChild(messagesContainer);

        activeChat.appendChild(upInterface);
        activeChat.appendChild(outerMessagesContainer);
        activeChat.appendChild(inputInterface);

        chatContainer.appendChild(activeChat);
    }

    function handleOwnMessage(text){
        const now = new Date();
        const ownMessageTime = now.toISOString();
        const ownMessage = createOwnMessage(text, ownMessageTime);

        messagesContainer.prepend(ownMessage);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        const chatElement = document.getElementById(`chatId-${interlocutorId}`);
        if(chatElement){
            chatListContainer.prepend(chatElement);
            updateChatLastMessageInfo(text, ownMessageTime, true);

        } else {

        }
    }

    function updateChatLastMessageInfo(text, date, ownMessage){
        const lastText = document.getElementById(`chat-lastMessageText-${interlocutorId}`);
        const lastDate = document.getElementById(`chat-lastMessageDate-${interlocutorId}`);

        if(text == null) {
            lastText.innerHTML = '&nbsp;'
        } else if(ownMessage) {
            lastText.textContent = `You: ${text}`;
        } else {
            lastText.textContent = text;
        }

        if(date == null) {
            lastDate.innerHTML = '&nbsp;'
        } else {
            lastDate.textContent = date;
        }
    }

    function createOwnMessage(text, ownMessageTime) {
        const messageElement = document.createElement('div');
        const messageInfo = document.createElement('div');
        messageInfo.className = 'message-info';
        const messageText = document.createElement('div');
        const messageUser = document.createElement('div');
        const messageStatus = document.createElement('div');
        const messageTime = document.createElement('div');

        messageElement.classList.add('message');
        messageText.textContent = text;
        messageTime.textContent = new Date().toLocaleTimeString();
        messageUser.textContent = `${authUserNickname}`;
        messageStatus.textContent = '!';
        messageTime.textContent = ownMessageTime;
        messageElement.appendChild(messageInfo);
        messageInfo.appendChild(messageUser);
        messageInfo.appendChild(messageStatus);
        messageInfo.appendChild(messageTime);
        messageElement.appendChild(messageText);

        return messageElement;
    }

    function showUnavailable() {

    }

    window.onload = function() {
        createSearchContainer();
        initWebSocket();

        if(interlocutorId === null){
            showEmpty();
<!--        } else if (interlocutorNickname === null){-->
<!--            showUnavailable();-->
        } else {
            showChat();
        }

    };
<!--    window.onpopstate = function(event) {-->
<!--        -->
<!--    };-->
    window.onbeforeunload = function() {
        if (stompClient) {
            stompClient.disconnect();
            sessionStorage.removeItem('stompConnected');
        }
    };
</script>
</body>
</html>