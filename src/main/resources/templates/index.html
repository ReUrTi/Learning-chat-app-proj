<!DOCTYPE html>
<html xmlns:th="http://www.w3.org/1999/xhtml">
<head>

    <title>Домашняя страница</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <link rel="stylesheet" href="/css/indexFull.css">
</head>
<body>
<div class="header">
    <div class="page-actions" style="margin-right: auto;">
        <form action="/index" method="get" style="display: inline;">
            <button type="submit">Chat</button>
        </form>
    </div>

    <div class="search-container" id="search-container">
        <!-- Search input and button will be generated by JavaScript -->
    </div>

    <div class="user-actions" style="margin-left: auto;">
        <span th:text="${nickname}"></span>
        <form action="/profile" method="get" style="display: inline;">
            <button type="submit">Profile</button>
        </form>
        <form action="/logout" method="get" style="display: inline;">
            <button type="submit">Exit</button>
        </form>
    </div>
</div>

<div class="main">
    <div class="side" id="chat-list" style="overflow-y: auto;"></div>
    <div class="center" id="chat-container"></div>
    <div class="side">Правая часть</div>
</div>

<script>

    function createSearchContainer() {
        const searchContainer = document.getElementById('search-container');

        const form = document.createElement('form');
        form.action = "/search";
        form.method = "get";

        const inputLabel = document.createElement('label');

        const input = document.createElement('input');
        input.type = "text";
        input.name = "searchInput";
        input.placeholder = "Введите имя пользователя...";

        const button = document.createElement('button');
        button.type = "submit";

        const img = document.createElement('img');
        img.src = "/images/search-icon.png";
        img.alt = "Search";
        img.style.width = "16px";
        img.style.height = "16px";

        form.onsubmit = function(event) {
            event.preventDefault(); // Предотвращаем стандартную отправку формы

            const trimmedInput = input.value.trim();

            const validInputPattern = /^[a-zA-Z0-9-_]+$/;

            if (trimmedInput === "") {
                alert("Пожалуйста, введите значение в поле поиска.");
                return;
            }

            if (!validInputPattern.test(trimmedInput)) {
                alert("Пожалуйста, используйте только буквы, цифры, '-' и '_' в поле поиска.");
                return;
            }

            if (trimmedInput.length > 30) {
                alert("Пожалуйста, введите не более 30 символов.");
                return;
            }

            input.value = trimmedInput;

            form.submit();
        };

        button.appendChild(img);
        inputLabel.appendChild(input);
        form.appendChild(inputLabel);
        form.appendChild(button);
        searchContainer.appendChild(form);
    }

<!--  Chat list handler  -->

    let stompClient = null;
    let pingInterval = 30000;
    let pingTimeout = 10000;
    const chatListContainer = document.getElementById('chat-list');
    const authUserId = [[${authUserId}]];
    let authUserNickname = '[[${nickname}]]';
    let requestedChatId = [[${requestedChatId} != null ? ${requestedChatId} : 'null']];
    let lastLoadedChatDate = new Date().toISOString().slice(0, 19).replace("T", " ");
    let lastLoadedMessageDate = new Date().toISOString().slice(0, 19).replace("T", " ");
    let loadingChats = false;
    let hasMoreChats = true;
    let chatsBatchLimit = 0;

    function initWebSocket() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        if (sessionStorage.getItem('stompConnected')) {
            console.log('STOMP is already connected.');
            return;
        }

        stompClient.connect({}, function(frame) {
            console.log('STOMP has been connected:', frame);
            sessionStorage.setItem('stompConnected', 'true');

            startPing();
            stompClient.subscribe('/user/topic/messages', handleMessages);
            stompClient.subscribe('/user/topic/chats', handleChats);
            loadChats(new Date().toISOString().slice(0, 19).replace("T", " "));
        }, function(error) {
            console.error('Error STOMP:', error);
        });

        socket.onclose = function () {
            console.error('Connection lost. Reload the page.');
        };
    }

    async function handleChats(response) {
        const data = await JSON.parse(response.body);
        console.log("Received response:", data);

        if (data.chats.length === 0) {
            hasMoreChats = false;
            chatListContainer.removeEventListener('scroll', checkScroll);
        } else {
            data.chats.forEach(chat => {
                renderChat(chat);
            });
            lastLoadedChatDate = data.lastChatDate.substring(0, 19).replace("T", " ");
        }
    }

    async function handleMessages(response){
        const data = await JSON.parse(response.body);
        console.log("Received response:", data);
    }

    async function loadChats(lastDate) {
        if (loadingChats || !hasMoreChats) return;

        loadingChats = true;
        try {
            const request = {
                limit: 20 + chatsBatchLimit,
                lastLoaded: lastDate,
                userId: authUserId
            };

            await stompClient.send('/app/chats/lazy', { 'Content-Type': 'application/json' }, JSON.stringify(request));
        } catch (error) {
            console.error("Ошибка при загрузке данных:", error);
        } finally {
            loadingChats = false;
        }
    }

    function renderChat(chat) {
        const chatElementId = `chatId${chat.chatId}`
        const chatElement = document.querySelector(`.side#chat-list #${chatElementId}`);
        if (chatElement) {
            return;
        }

        const chatDiv = document.createElement('div');
        chatDiv.className = 'chat-div';
        chatDiv.id = chatElementId;
        chatDiv.addEventListener('click', () => {

            history.pushState(state, '', `?chatId=${chat.chatId}`);
        });
        chatDiv.addEventListener('mouseover', () => {
            chatDiv.style.backgroundColor = '#e0e0e0';
        });
        chatDiv.addEventListener('mouseout', () => {
            chatDiv.style.backgroundColor = '#f0f0f0';
        });

        const chatMain = document.createElement('div');
        chatMain.className = 'chat-main';
        chatMain.style.position = 'relative';

        const chatLastMessageInfo = document.createElement('div');
        chatLastMessageInfo.className = 'chat-lastMessage-info';
        chatLastMessageInfo.style.position = 'relative';

        const chatLastMessageText = document.createElement('div');
        chatLastMessageText.className = 'chat-lastMessage-text';
        if(chat.lastMessage == null) {
            chatLastMessageText.innerHTML = `
                <span> </span>
            `;
        } else if(chat.lastMessageUserId === Number(authUserId)) {
            chatLastMessageText.innerHTML = `
                <span>You: ${chat.lastMessage}</span>
            `;
        } else {
            chatLastMessageText.innerHTML = `
                <span>${chat.lastMessage}</span>
            `;
        }

        const chatLastMessageDate = document.createElement('div');
        chatLastMessageDate.className = 'chat-lastMessage-date';
        if(chat.lastMessageDate == null) {
            chatLastMessageDate.innerHTML = `
                <span> </span>
            `;
        } else {
            chatLastMessageDate.innerHTML = `
                <span>${chat.lastMessageDate}</span>
            `;
        }

        const chatInfo = document.createElement('div');
        chatInfo.className = 'chat-info';
        chatInfo.innerHTML = `
            <span>Nickname: ${chat.interlocutorNickname}</span><br>
            <span>ID: ${chat.interlocutorId}</span>
        `;

        const chatOther = document.createElement('div');
        chatOther.className = 'chat-other';

        const chatDropdown = document.createElement('div');
        chatOther.className = 'chat-dropdown';

        const chatDropdownButton = document.createElement('button');
        chatDropdownButton.innerText = '...';

        const chatDropdownContainer = document.createElement('div');
        chatDropdownContainer.className = 'dropdown';
        chatDropdownContainer.style.display = 'none';

        const hideChatDiv = document.createElement('div');
        hideChatDiv.className = 'dropdown-item';
        hideChatDiv.innerText = 'Hide';
        hideChatDiv.addEventListener('click', hideChat(                               ));
        chatDropdownContainer.appendChild(hideChatDiv);

        const blockChatDiv = document.createElement('div');
        blockChatDiv.className = 'dropdown-item';
        blockChatDiv.innerText = 'Block';
        blockChatDiv.addEventListener('click', blockChat(                               ));
        chatDropdownContainer.appendChild(blockChatDiv);

        let hideTimeout;
        chatDropdownButton.addEventListener('mouseenter', () => {
            clearTimeout(hideTimeout); // Очищаем таймер, если он установлен
            chatDropdownContainer.style.display = 'block'; // Показываем меню
        });
        chatDropdownButton.addEventListener('mouseleave', () => {
            hideTimeout = setTimeout(() => {
                chatDropdownContainer.style.display = 'none';
            }, 1000);
        });
        chatDropdownContainer.addEventListener('mouseenter', () => {
            clearTimeout(hideTimeout);
            chatDropdownContainer.style.display = 'block';
        });
        chatDropdownContainer.addEventListener('mouseleave', () => {
            hideTimeout = setTimeout(() => {
                chatDropdownContainer.style.display = 'none';
            }, 1000);
        });

        const chatUnread = document.createElement('div');
        chatUnread.className = 'chat-unread';
        if(chat.unreadCount >= 100) {
            chatUnread.innerHTML = `
                <span>99+</span>
            `;
        } else if (chat.unreadCount > 0) {
            chatUnread.innerHTML = `
                <span>${chat.unreadCount}</span>
            `;
        }

        chatDropdown.appendChild(chatDropdownButton);
        chatDropdown.appendChild(chatDropdownContainer);
        chatOther.appendChild(chatDropdown);
        chatOther.appendChild(chatUnread);

        chatMain.appendChild(chatInfo);
        chatMain.appendChild(chatOther);

        chatLastMessageInfo.appendChild(chatLastMessageText);
        chatLastMessageInfo.appendChild(chatLastMessageDate);

        chatDiv.appendChild(chatMain);
        chatDiv.appendChild(chatLastMessageInfo);

        chatListContainer.appendChild(chatDiv);
    }

    function hideChat() {
    }
    function blockChat() {
    }

    var pingTimeoutId;
    function startPing() {
        pingIntervalId = setInterval(function () {
            if (stompClient && stompClient.connected) {
                stompClient.send('/app/ping', {}, JSON.stringify({}));
                pingTimeoutId = setTimeout(function () {
                    console.warn('Ping timeout, reconnecting...');
                    stompClient.disconnect();
                }, pingTimeout);
            }
        }, pingInterval);
        stompClient.subscribe('/user/topic/pong', function (message) {
            clearTimeout(pingTimeoutId);
            console.log('Received pong response from server:', message);
        });
    }

    function checkScroll() {
        const scrollPosition = chatListContainer.scrollTop + chatListContainer.clientHeight;
        const threshold = chatListContainer.scrollHeight - 100;

        if (scrollPosition >= threshold) {
            loadChats(lastLoadedChatDate);
        }
    }
    chatListContainer.addEventListener('scroll', checkScroll);

<!--  Message-container handler  -->

    const chatContainer = document.getElementById('chat-container');

    function showEmpty() {
        const chatContainer = document.getElementById('chat-container');

        const noChat = document.createElement('div');
        noChat.innerHTML = `Open the existing chat, or find it using the search.`;
        noChat.className = 'no-chat';

        chatContainer.appendChild(noChat);
    }

    function showChat() {
        const chatContainer = document.getElementById('chat-container');

        const activeChat = document.createElement('div');
        activeChat.className = 'active-chat';
        activeChat.id = `active-chat-${requestedChatId}`;

        upInterface = document.createElement('div');
        upInterface.className = 'up-interface';

        closeButtonDiv = document.createElement('div');
        closeButtonDiv.className = 'close-button-div';

        closeChatButton = document.createElement('button');
        closeChatButton.className = 'close-chat-button';
        closeChatButton.innerHTML = `
            <button onclick="">X</button>
        `;

        chatInfoDiv = document.createElement('div');
        chatInfoDiv.className = 'chat-info-div';
        chatInfoDiv.innerHTML = `Testing. ChatId: ${requestedChatId}`;

        optionsDiv = document.createElement('div');
        optionsDiv.className = 'options-div';

        optionsChatButton = document.createElement('button');
        optionsChatButton.className = 'options-chat-button';
        optionsChatButton.innerHTML = `
            <button onclick="">...</button>
        `;

        messagesContainer = document.createElement('div');
        messagesContainer.className = 'message-container';
        messagesContainer.id = 'message-container-id';

        innerMessagesContainer = document.createElement('div');

        inputInterface = document.createElement('div');
        inputInterface.className = 'input-container';

        const messageInput = document.createElement('input');
        messageInput.type = 'text';
        messageInput.placeholder = 'Message...';
        inputInterface.appendChild(messageInput);

        const sendButton = document.createElement('button');
        sendButton.textContent = 'Send';
        inputInterface.appendChild(sendButton);

        sendButton.addEventListener('click', () => {
            const messageText = messageInput.value.trim();
            if (messageText) {
                addMessageToChat(messageText);
                messageInput.value = '';
                messageInput.focus();
            }
        });
        messageInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendButton.click();
            }
        });
        function addMessageToChat(text) {
            const messageElement = document.createElement('div');
            const messageInfo = document.createElement('div');
            messageInfo.className = 'message-info';
            const messageText = document.createElement('div');
            const messageUser = document.createElement('div');
            const messageStatus = document.createElement('div');
            const messageTime = document.createElement('div');

            messageElement.classList.add('message');
            messageText.textContent = text;
            messageTime.textContent = new Date().toLocaleTimeString();
            messageUser.textContent = `${authUserNickname}`;
            messageElement.appendChild(messageInfo);
            messageInfo.appendChild(messageUser);
            messageInfo.appendChild(messageStatus);
            messageInfo.appendChild(messageTime);
            messageElement.appendChild(messageText);

            messagesContainer.prepend(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        upInterface.appendChild(closeButtonDiv);
        closeButtonDiv.appendChild(closeChatButton);
        upInterface.appendChild(chatInfoDiv);
        upInterface.appendChild(optionsDiv);
        optionsDiv.appendChild(optionsChatButton);

        messagesContainer.appendChild(innerMessagesContainer);
        messagesContainer.className = 'message-container';

        activeChat.appendChild(upInterface);
        activeChat.appendChild(messagesContainer);
        activeChat.appendChild(inputInterface);

        chatContainer.appendChild(activeChat);
    }

    window.onload = function() {
        createSearchContainer();
        initWebSocket();

        if(requestedChatId == null){
            showEmpty();
        } else {
            showChat();
        }

    };
    window.onpopstate = function(event) {

    };
    window.onbeforeunload = function() {
        if (stompClient) {
            stompClient.disconnect();
            sessionStorage.removeItem('stompConnected');
        }
    };
</script>
</body>
</html>